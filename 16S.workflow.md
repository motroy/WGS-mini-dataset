%mermaid

graph TD
    %% Define Stages
    subgraph Raw Data & Metadata
        A[Raw Sequencing Reads (.fastq/.fastq.gz)];
        B[Sample Metadata (.tsv)];
    end

    subgraph QIIME 2 Processing
        direction LR
        C{1. Import Data};
        D{2. Quality Control & Denoising (e.g., DADA2, Deblur)};
        E[Feature Table (ASVs/OTUs)];
        F[Representative Sequences (.fasta)];
        G{3. Assign Taxonomy};
        H[Taxonomy Table];
        I{4. Build Phylogenetic Tree};
        J[Phylogenetic Tree (.nwk)];
        K{5. Export Artifacts};
        L[Exported: table.biom/tsv, taxonomy.tsv, tree.nwk];
    end

    subgraph R & microeco Analysis
        direction LR
        M{6. Import Data into R};
        N{7. Create 'microtable' object (microeco)};
        O{8. Alpha Diversity Analysis};
        P[Alpha Diversity Metrics & Plots (e.g., Shannon, Chao1)];
        Q{9. Beta Diversity Analysis};
        R[Beta Diversity Metrics, Ordination & Stats (e.g., Bray-Curtis, UniFrac, PCoA, PERMANOVA)];
        S{10. Taxonomic Composition Analysis};
        T[Taxonomic Plots (Bar plots, Heatmaps)];
        U{11. Differential Abundance (Optional, e.g., LEfSe)};
        V[Differentially Abundant Features];
    end

    subgraph Final Output
       W[Results Interpretation & Publication Figures];
    end

    %% Define Connections
    A --> C;
    B --> C;  % Metadata often imported early or used alongside tables later

    C --> D;
    D --> E;  % Denoising produces Feature Table
    D --> F;  % Denoising produces Representative Sequences

    F --> G;  % Rep Seqs needed for Taxonomy
    G --> H;

    F --> I;  % Rep Seqs needed for Tree Building
    I --> J;

    E --> K;  % Export Feature Table
    H --> K;  % Export Taxonomy
    J --> K;  % Export Tree
    K --> L;

    B --> M;  % Metadata needed in R
    L --> M;  % Exported QIIME2 files needed in R

    M --> N;  % Create the central microeco object

    N --> O;
    O --> P;

    N --> Q;
    Q --> R;

    N --> S;
    S --> T;

    N --> U;  % Optional step
    U --> V;

    P --> W;
    R --> W;
    T --> W;
    V --> W; % If differential abundance was performed

    %% Styling (Optional - for better visual separation)
    classDef qiime fill:#90EE90,stroke:#333,stroke-width:2px;
    classDef rpkg fill:#ADD8E6,stroke:#333,stroke-width:2px;
    classDef data fill:#f9f,stroke:#333,stroke-width:1px;
    classDef result fill:#FFD700,stroke:#333,stroke-width:2px;

    class A,B,E,F,H,J,L,P,R,T,V data;
    class C,D,G,I,K qiime;
    class M,N,O,Q,S,U rpkg;
    class W result;
